
import os
import time
import random
import logging
import datetime
import pytz
import requests

TOKEN = os.getenv("BOT_TOKEN")
CHAT_IDS = os.getenv("CHAT_IDS", "").split(",")

# –¢–≤–æ—ë –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–∏—Å—Ç–µ–º–Ω–æ–µ –≤—Ä–µ–º—è (–ø–æ —Ö–æ—Å—Ç–∏–Ω–≥—É)
local = datetime.datetime.now().astimezone().tzinfo
berlin = pytz.timezone("Europe/Berlin")

# –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –∂–µ–Ω—ã –ø–æ –ë–µ—Ä–ª–∏–Ω—É
wife_schedule = {
    7: "morning", 7.5: "morning", 8: "morning", 8.5: "morning", 9: "morning",
    15: "evening", 20: "evening", 21: "evening", 22: "evening",
    23: "late", 0: "late"
}

# –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ "–∑–∞–ø–∏—Å—å" –ø–æ —Å–∏—Å—Ç–µ–º–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏ (—Ç–≤–æ–µ —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–Ω–æ–µ –≤—Ä–µ–º—è)
your_schedule = [8.966, 9.966, 10.966, 11.966, 20.966, 21.966, 22.966, 23.966]

messages = {
    "morning": [
        "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ, –∑–∞—è! –ü–æ–¥–∫–ª—é—á–∏ –∑–∞—Ä—è–¥–∫—É, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞‚ù§Ô∏è.",
        "–ó–∞—Ä—è–¥–∫–∞ ‚Äî –∑–∞–ª–æ–≥ –∑–¥–æ—Ä–æ–≤—å—è. –ù–∞—á–∏–Ω–∞–π!",
        "–£—Ç—Ä–µ–Ω–Ω—è—è –∑–∞–±–æ—Ç–∞üòâ: –Ω–µ –∑–∞–±—É–¥—å –∑–∞—Ä—è–¥–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω.",
        "7:30 ‚Äî —Ç—ã –∑–∞—Ä—è–¥–∏–ª–∞—Å—å —ç–Ω–µ—Ä–≥–∏–µ–π?",
        "–ü–æ—Ä–∞–¥—É–π –º–µ–Ω—è ‚Äî –ø–æ—Ä–∞–¥—É–π —Ç–µ–ª–µ—Ñ–æ–Ω! –í—Å—Ç–∞–≤–ª—è–π üòâ",
        "–Ø –≤—Å—ë –µ—â—ë –Ω–∞–¥–µ—é—Å—å, —á—Ç–æ —Ç–µ–ª–µ—Ñ–æ–Ω —É–∂–µ –Ω–∞ –∑–∞—Ä—è–¥–∫–µ.",
        "8:00 ‚Äî –≤—Å—ë –µ—â—ë 13%?",
        "–õ—é–±–∏–º–∞—è, –∑–∞—Ä—è–¥–∫–∞ –Ω–µ —à—É—Ç–∫–∞. –•–∏—Ö–∏–∫!",
        "–¢—ã –∂–µ –∑–Ω–∞–µ—à—å, —è —É—Ç–æ–º–ª—é)) –¥–∞–≤–∞–π - –∑–∞—Ä—è–∂–∞–π)."
    ],
    "evening": [
        "–í–µ—á–µ—Ä–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –∑–∞—Ä—è–¥–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞?",
        "–ù–µ–∂–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞—é: –ø–æ—Ä–∞ –∑–∞—Ä—è–∂–∞—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω.",
        "21:00 ‚Äî –∞ –∑–∞—Ä—è–¥–∫–∞?",
        "22:00 ‚Äî –µ—â—ë –Ω–µ –Ω–∞ –∑–∞—Ä—è–¥–∫–µ?",
        "–ü–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–Ω—Å! –ü–æ—Å—Ç–∞–≤—å —Ç–µ–ª–µ—Ñ–æ–Ω –Ω–∞ –∑–∞—Ä—è–¥–∫—É.",
        "–°–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ –≤ —Å–µ–º—å–µ ‚Äî –∑–∞—Ä—è–¥–∫–∞ –≤ –≥–Ω–µ–∑–¥–µ.",
        "–°–¥–µ–ª–∞–π —Ö–æ—Ä–æ—à–æ - –≤—Å—Ç–∞–≤—å –ø–æ–≥–ª—É–±–∂–µ."
    ],
    "late": [
        "–ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∏ –ª–æ–∂–∏—Å—å —Å–ø–∞—Ç—å.",
        "–¢—ã —Ç–æ—á–Ω–æ —Ö–æ—á–µ—à—å, —á—Ç–æ–±—ã –æ–Ω —É–º–µ—Ä?-–¥–µ–π—Å—Ç–≤—É–π!",
        "–Ø –Ω–µ —à—É—á—É. –ü–æ–¥–∫–ª—é—á–∏ –∑–∞—Ä—è–¥–∫—É.",
        "–ú—ã –≤ –æ—Ç–≤–µ—Ç–µ –∑–∞ —Ç–µ—Ö, –∫–æ–≥–æ –Ω–µ –∑–∞—Ä—è–∂–∞–µ–º.",
        "–î–∞–∂–µ –∫–æ–≥–¥–∞ —è —Å–ø–ª—é - –±–æ—Ç —Å–ª–µ–¥–∏—Ç.",
        "–ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–≤–æ–Ω–æ–∫. –ò–ª–∏ –ø–æ—Ç–æ–º –±—É–¥–µ—Ç –∑–≤–æ–Ω–∫–∞).",
        "–ï—Å–ª–∏ –Ω–µ –Ω–∞ –∑–∞—Ä—è–¥–∫–µ ‚Äî —è –ø–ª–∞–∫–∞—Ç—å."
    ]
}

def send(text, cid):
    url = f"https://api.telegram.org/bot{TOKEN}/sendMessage"
    try:
        requests.post(url, data={"chat_id": cid.strip(), "text": text})
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ {cid}: {e}")

def hour_now(tz):
    now = datetime.datetime.now(tz)
    return now.hour + now.minute / 60.0

def main():
    log = []
    h_local = hour_now(local)
    h_berlin = hour_now(berlin)

    wife_id = CHAT_IDS[0]
    me_id = CHAT_IDS[1]

    if any(abs(h_local - t) < 0.05 for t in your_schedule):
        send("–∑–∞–ø–∏—Å—å", me_id)
        log.append("–∑–∞–ø–∏—Å—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞")

    for h, category in wife_schedule.items():
        if abs(h_berlin - h) < 0.05:
            send(random.choice(messages[category]), wife_id)
            log.append(f"{category} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∂–µ–Ω–µ")
            break

    with open("bot_log.txt", "a") as f:
        f.write(f"{datetime.datetime.now()} | –ë–µ—Ä–ª–∏–Ω: {h_berlin:.2f}, –õ–æ–∫–∞–ª—å–Ω–æ–µ: {h_local:.2f} | {log}\n")

send("–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: –±–æ—Ç –∑–∞–ø—É—â–µ–Ω", CHAT_IDS[1])

if __name__ == "__main__":
    main()
